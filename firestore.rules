rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Règles pour les influenceurs
    match /influencers/{influencerId} {
      // Tout le monde peut lire les profils d'influenceurs
      allow read: if true;
      // Seul l'influenceur peut modifier son propre profil
      allow write: if request.auth != null && request.auth.uid == influencerId;
    }
    
    // Règles pour les marques
    match /brands/{brandId} {
      // Tout le monde peut lire les profils de marques
      allow read: if true;
      // Seule la marque peut modifier son propre profil
      allow write: if request.auth != null && request.auth.uid == brandId;
    }
    
    // Règles pour les collaborations
    match /collaborations/{collaborationId} {
      // Les marques et influenceurs peuvent lire leurs propres collaborations
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.brandId || 
                      request.auth.uid == resource.data.influencerId);
      
      // Les marques peuvent créer des collaborations
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.brandId;
      
      // Les marques et influenceurs peuvent mettre à jour leurs collaborations
      allow update: if request.auth != null && 
                       (request.auth.uid == resource.data.brandId || 
                        request.auth.uid == resource.data.influencerId);
      
      // Seule la marque qui a créé peut supprimer
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.brandId;
    }
    
    // Règles pour les conversations
    match /conversations/{conversationId} {
      // Les participants peuvent lire leurs conversations
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.brandId || 
                      request.auth.uid == resource.data.influencerId);
      
      // Les marques peuvent créer des conversations
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.brandId;
      
      // Les participants peuvent mettre à jour les conversations
      allow update: if request.auth != null && 
                       (request.auth.uid == resource.data.brandId || 
                        request.auth.uid == resource.data.influencerId);
      
      // Règles pour les messages dans les conversations
      match /messages/{messageId} {
        // Les participants peuvent lire les messages
        allow read: if request.auth != null && 
                       (request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.brandId || 
                        request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.influencerId);
        
        // Les participants peuvent créer des messages
        allow create: if request.auth != null && 
                         (request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.brandId || 
                          request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.influencerId) &&
                         request.auth.uid == request.resource.data.senderId;
        
        // Les participants peuvent mettre à jour leurs propres messages
        allow update: if request.auth != null && 
                         request.auth.uid == resource.data.senderId;
      }
    }
    
    // Règles pour les contacts
    match /contacts/{contactId} {
      // Tout le monde peut créer un contact
      allow create: if true;
      // Seuls les admins peuvent lire/modifier (à définir selon tes besoins)
      allow read, update, delete: if request.auth != null;
    }
    
    // Règles pour les admins (si tu as une collection admin)
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.uid == adminId;
    }
  }
}
